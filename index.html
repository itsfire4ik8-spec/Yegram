<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <title>Yegram ‚úàÔ∏è - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –¥–ª—è –¥—Ä—É–∑–µ–π</title>
    <style>
        body { font-family: Arial; max-width: 600px; margin: auto; padding: 20px; background: linear-gradient(135deg, #667eea, #764ba2); min-height: 100vh; }
        .container { background: white; padding: 20px; border-radius: 15px; box-shadow: 0 10px 30px rgba(0,0,0,0.2); }
        #chat { height: 300px; border: 1px solid #ddd; border-radius: 10px; padding: 10px; margin: 10px 0; overflow-y: auto; }
        .msg { margin: 8px 0; padding: 10px; border-radius: 10px; max-width: 80%; }
        .my-msg { background: #667eea; color: white; margin-left: auto; text-align: right; }
        .their-msg { background: #f0f0f0; margin-right: auto; }
        .system-msg { background: #fff3cd; color: #856404; text-align: center; font-size: 0.9em; }
        input, button { padding: 12px; margin: 5px 0; border-radius: 8px; border: 1px solid #ddd; width: 100%; }
        button { background: #667eea; color: white; border: none; cursor: pointer; }
        button:hover { background: #5a6fd8; }
        .id-box { background: #f8f9fa; padding: 15px; border-radius: 10px; margin: 10px 0; }
        .status { padding: 5px 10px; border-radius: 5px; display: inline-block; }
        .online { background: #4CAF50; color: white; }
        .offline { background: #f44336; color: white; }
    </style>
    <!-- –ü–æ–¥–∫–ª—é—á–∞–µ–º PeerJS -->
    <script src="https://unpkg.com/peerjs@1.4.7/dist/peerjs.min.js"></script>
</head>
<body>
    <div class="container">
        <h1 style="text-align: center;">‚úàÔ∏è Yegram</h1>
        <p style="text-align: center; color: #666;">–ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –¥–ª—è –¥—Ä—É–∑–µ–π (–±–µ–∑ —Å–µ—Ä–≤–µ—Ä–∞!)</p>
        
        <!-- –≠–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ -->
        <div id="setup">
            <div class="status offline" id="status">–û—Ç–∫–ª—é—á–µ–Ω</div>
            
            <div class="id-box">
                <p><strong>–í–∞—à ID:</strong></p>
                <div style="display: flex; gap: 10px;">
                    <input type="text" id="myId" readonly style="flex: 1;">
                    <button onclick="copyMyId()" style="width: auto;">üìã –ö–æ–ø–∏—Ä–æ–≤–∞—Ç—å</button>
                </div>
            </div>
            
            <div style="margin: 20px 0;">
                <p><strong>–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ –¥—Ä—É–≥—É:</strong></p>
                <input type="text" id="friendId" placeholder="–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞">
                <button onclick="connectToFriend()">üîó –ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
            
            <div style="background: #f8f9fa; padding: 15px; border-radius: 10px; margin-top: 20px;">
                <p><strong>–ö–∞–∫ –ø–æ–ª—å–∑–æ–≤–∞—Ç—å—Å—è:</strong></p>
                <p>1. –û—Ç–∫—Ä–æ–π—Ç–µ —ç—Ç—É —Å—Ç—Ä–∞–Ω–∏—Ü—É —Å –¥—Ä—É–≥–æ–º</p>
                <p>2. –°–∫–æ–ø–∏—Ä—É–π—Ç–µ —Å–≤–æ–π ID –∏ –æ—Ç–ø—Ä–∞–≤—å—Ç–µ –¥—Ä—É–≥—É</p>
                <p>3. –í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞ –≤ –ø–æ–ª–µ –≤—ã—à–µ</p>
                <p>4. –ù–∞–∂–º–∏—Ç–µ "–ü–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è"</p>
                <p>5. –û–±—â–∞–π—Ç–µ—Å—å!</p>
            </div>
        </div>
        
        <!-- –≠–∫—Ä–∞–Ω —á–∞—Ç–∞ -->
        <div id="chatScreen" style="display: none;">
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <h3 id="chatWith">–ß–∞—Ç —Å –¥—Ä—É–≥–æ–º</h3>
                <button onclick="disconnect()" style="width: auto; background: #f44336;">‚ùå –û—Ç–∫–ª—é—á–∏—Ç—å—Å—è</button>
            </div>
            
            <div id="chat"></div>
            
            <div style="display: flex; gap: 10px; margin-top: 10px;">
                <input type="text" id="message" placeholder="–í–≤–µ–¥–∏—Ç–µ —Å–æ–æ–±—â–µ–Ω–∏–µ..." onkeypress="if(event.key=='Enter')sendMessage()">
                <button onclick="sendMessage()" style="width: auto;">üì§ –û—Ç–ø—Ä–∞–≤–∏—Ç—å</button>
            </div>
        </div>
        
        <div style="margin-top: 20px; text-align: center; color: #666; font-size: 0.9em;">
            <p>–†–∞–±–æ—Ç–∞–µ—Ç –Ω–∞ PeerJS ‚Ä¢ –°–æ–æ–±—â–µ–Ω–∏—è –∏–¥—É—Ç –Ω–∞–ø—Ä—è–º—É—é –º–µ–∂–¥—É –≤–∞–º–∏</p>
        </div>
    </div>

    <script>
        // Yegram - –ú–µ—Å—Å–µ–Ω–¥–∂–µ—Ä –Ω–∞ PeerJS
        let peer = null;
        let conn = null;
        let myId = null;
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
        window.onload = function() {
            init();
        };
        
        function init() {
            // –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º —Å–ª—É—á–∞–π–Ω—ã–π ID
            myId = 'yegram_' + Math.random().toString(36).substr(2, 9);
            document.getElementById('myId').value = myId;
            
            // –°–æ–∑–¥–∞–µ–º Peer –æ–±—ä–µ–∫—Ç
            // PeerJS –∏—Å–ø–æ–ª—å–∑—É–µ—Ç —Å–≤–æ–π –ø—É–±–ª–∏—á–Ω—ã–π —Å–µ—Ä–≤–µ—Ä –¥–ª—è –æ–±–º–µ–Ω–∞ —Å–∏–≥–Ω–∞–ª–∞–º–∏
            peer = new Peer(myId, {
                host: '0.peerjs.com',
                port: 443,
                path: '/',
                secure: true,
                config: {
                    iceServers: [
                        { urls: 'stun:stun.l.google.com:19302' },
                        { urls: 'stun:stun1.l.google.com:19302' },
                        { urls: 'stun:stun2.l.google.com:19302' }
                    ]
                }
            });
            
            // –°–æ–±—ã—Ç–∏—è Peer
            peer.on('open', function(id) {
                console.log('‚úÖ Peer –ø–æ–¥–∫–ª—é—á–µ–Ω. ID:', id);
                document.getElementById('myId').value = id;
                myId = id;
                updateStatus('online', '‚úÖ –û–Ω–ª–∞–π–Ω');
            });
            
            peer.on('connection', function(connection) {
                console.log('üìû –í—Ö–æ–¥—è—â–µ–µ –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ –æ—Ç:', connection.peer);
                conn = connection;
                setupConnection();
                showChatScreen();
                updateStatus('online', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ ' + connection.peer.substring(0, 8) + '...');
            });
            
            peer.on('error', function(err) {
                console.error('‚ùå –û—à–∏–±–∫–∞ Peer:', err);
                updateStatus('offline', '‚ùå –û—à–∏–±–∫–∞: ' + err.type);
            });
            
            peer.on('disconnected', function() {
                console.log('‚ùå Peer –æ—Ç–∫–ª—é—á–µ–Ω');
                updateStatus('offline', '‚ùå –û—Ç–∫–ª—é—á–µ–Ω –æ—Ç —Å–µ—Ä–≤–µ—Ä–∞');
                // –ü—Ä–æ–±—É–µ–º –ø–µ—Ä–µ–ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è
                setTimeout(() => peer.reconnect(), 3000);
            });
        }
        
        function connectToFriend() {
            const friendId = document.getElementById('friendId').value.trim();
            if (!friendId) {
                alert('–í–≤–µ–¥–∏—Ç–µ ID –¥—Ä—É–≥–∞');
                return;
            }
            
            if (friendId === myId) {
                alert('–ù–µ–ª—å–∑—è –ø–æ–¥–∫–ª—é—á–∏—Ç—å—Å—è –∫ —Å–∞–º–æ–º—É —Å–µ–±–µ');
                return;
            }
            
            console.log('–ü–æ–¥–∫–ª—é—á–∞—é—Å—å –∫:', friendId);
            
            // –°–æ–∑–¥–∞–µ–º –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ
            conn = peer.connect(friendId, {
                reliable: true
            });
            
            if (!conn) {
                alert('–ù–µ —É–¥–∞–ª–æ—Å—å —Å–æ–∑–¥–∞—Ç—å –ø–æ–¥–∫–ª—é—á–µ–Ω–∏–µ');
                return;
            }
            
            setupConnection();
            showChatScreen();
            updateStatus('connecting', '‚è≥ –ü–æ–¥–∫–ª—é—á–∞–µ–º—Å—è...');
        }
        
        function setupConnection() {
            conn.on('open', function() {
                console.log('‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ');
                updateStatus('online', '‚úÖ –ü–æ–¥–∫–ª—é—á–µ–Ω –∫ –¥—Ä—É–≥—É');
                addSystemMessage('‚úÖ –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —É—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–æ! –ú–æ–∂–Ω–æ –æ–±—â–∞—Ç—å—Å—è.');
                
                // –û–±–Ω–æ–≤–ª—è–µ–º –∑–∞–≥–æ–ª–æ–≤–æ–∫ —á–∞—Ç–∞
                document.getElementById('chatWith').textContent = '–ß–∞—Ç —Å ' + conn.peer.substring(0, 8) + '...';
            });
            
            conn.on('data', function(data) {
                console.log('–ü–æ–ª—É—á–µ–Ω–æ —Å–æ–æ–±—â–µ–Ω–∏–µ:', data);
                addMessage(data, 'friend');
            });
            
            conn.on('close', function() {
                console.log('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ –∑–∞–∫—Ä—ã—Ç–æ');
                updateStatus('offline', '‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ');
                addSystemMessage('‚ùå –°–æ–µ–¥–∏–Ω–µ–Ω–∏–µ —Ä–∞–∑–æ—Ä–≤–∞–Ω–æ');
                
                // –í–æ–∑–≤—Ä–∞—â–∞–µ–º –Ω–∞ —ç–∫—Ä–∞–Ω –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ —á–µ—Ä–µ–∑ 3 —Å–µ–∫—É–Ω–¥—ã
                setTimeout(() => {
                    if (!conn || conn.open === false) {
                        showSetupScreen();
                    }
                }, 3000);
            });
            
            conn.on('error', function(err) {
                console.error('–û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è:', err);
                updateStatus('offline', '‚ùå –û—à–∏–±–∫–∞ —Å–æ–µ–¥–∏–Ω–µ–Ω–∏—è');
            });
        }
        
        function sendMessage() {
            const messageInput = document.getElementById('message');
            const message = messageInput.value.trim();
            
            if (!message) return;
            
            if (conn && conn.open) {
                // –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ
                conn.send(message);
                addMessage(message, 'me');
                messageInput.value = '';
            } else {
                alert('–°–Ω–∞—á–∞–ª–∞ –ø–æ–¥–∫–ª—é—á–∏—Ç–µ—Å—å –∫ –¥—Ä—É–≥—É!');
            }
        }
        
        function addMessage(text, sender) {
            const chat = document.getElementById('chat');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'msg ' + (sender === 'me' ? 'my-msg' : 'their-msg');
            messageDiv.textContent = text;
            chat.appendChild(messageDiv);
            
            // –ü—Ä–æ–∫—Ä—É—á–∏–≤–∞–µ–º –≤–Ω–∏–∑
            chat.scrollTop = chat.scrollHeight;
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤ localStorage
            saveMessage(text, sender);
        }
        
        function addSystemMessage(text) {
            const chat = document.getElementById('chat');
            const messageDiv = document.createElement('div');
            messageDiv.className = 'msg system-msg';
            messageDiv.textContent = text;
            chat.appendChild(messageDiv);
            
            chat.scrollTop = chat.scrollHeight;
        }
        
        function saveMessage(text, sender) {
            if (!conn) return;
            
            const chatKey = 'yegram_chat_' + conn.peer;
            const messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            messages.push({
                text: text,
                sender: sender,
                time: new Date().toLocaleTimeString('ru-RU', { hour: '2-digit', minute: '2-digit' })
            });
            
            // –°–æ—Ö—Ä–∞–Ω—è–µ–º —Ç–æ–ª—å–∫–æ –ø–æ—Å–ª–µ–¥–Ω–∏–µ 100 —Å–æ–æ–±—â–µ–Ω–∏–π
            if (messages.length > 100) {
                messages.splice(0, messages.length - 100);
            }
            
            localStorage.setItem(chatKey, JSON.stringify(messages));
        }
        
        function loadMessages() {
            if (!conn) return;
            
            const chatKey = 'yegram_chat_' + conn.peer;
            const messages = JSON.parse(localStorage.getItem(chatKey) || '[]');
            
            const chat = document.getElementById('chat');
            chat.innerHTML = '';
            
            messages.forEach(msg => {
                const messageDiv = document.createElement('div');
                messageDiv.className = 'msg ' + (msg.sender === 'me' ? 'my-msg' : 'their-msg');
                messageDiv.textContent = msg.text;
                chat.appendChild(messageDiv);
            });
            
            chat.scrollTop = chat.scrollHeight;
        }
        
        function copyMyId() {
            const idInput = document.getElementById('myId');
            idInput.select();
            document.execCommand('copy');
            
            // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —É–≤–µ–¥–æ–º–ª–µ–Ω–∏–µ
            const originalText = idInput.value;
            idInput.value = '‚úÖ –°–∫–æ–ø–∏—Ä–æ–≤–∞–Ω–æ!';
            setTimeout(() => {
                idInput.value = originalText;
            }, 1500);
        }
        
        function showChatScreen() {
            document.getElementById('setup').style.display = 'none';
            document.getElementById('chatScreen').style.display = 'block';
            
            // –ó–∞–≥—Ä—É–∂–∞–µ–º –∏—Å—Ç–æ—Ä–∏—é —Å–æ–æ–±—â–µ–Ω–∏–π
            setTimeout(loadMessages, 100);
        }
        
        function showSetupScreen() {
            document.getElementById('setup').style.display = 'block';
            document.getElementById('chatScreen').style.display = 'none';
            document.getElementById('chat').innerHTML = '';
            document.getElementById('friendId').value = '';
            document.getElementById('message').value = '';
            
            // –ó–∞–∫—Ä—ã–≤–∞–µ–º —Å–æ–µ–¥–∏–Ω–µ–Ω–∏–µ
            if (conn) {
                conn.close();
                conn = null;
            }
        }
        
        function disconnect() {
            if (conn) {
                conn.close();
                conn = null;
            }
            
            addSystemMessage('–í—ã –æ—Ç–∫–ª—é—á–∏–ª–∏—Å—å –æ—Ç —á–∞—Ç–∞');
            setTimeout(showSetupScreen, 1000);
        }
        
        function updateStatus(type, text) {
            const statusEl = document.getElementById('status');
            statusEl.textContent = text;
            statusEl.className = 'status ' + type;
        }
        
        // –ê–≤—Ç–æ–æ—Ç–∫–ª—é—á–µ–Ω–∏–µ –ø—Ä–∏ –∑–∞–∫—Ä—ã—Ç–∏–∏ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
        window.addEventListener('beforeunload', function() {
            if (conn) {
                conn.close();
            }
            if (peer) {
                peer.destroy();
            }
        });
    </script>
</body>
</html>
